

```{python}
#| label: setup
import sys
sys.path.insert(0, ".")
from _common import *
import plotly.graph_objects as go
```

# Multi-Criteria Analysis {#sec-mca}

::: {.chapter-opening}
Economic efficiency is one lens among several. Implementation feasibility, climate resilience, and distributional equity also matter for a decision of this scale. This chapter scores each scenario against eight criteria.
:::

## Framework: Eight Criteria

Following @adb_guidelines2017 §7.3 and @dodgson2009, eight criteria cover the economic, environmental, social, and institutional dimensions of the transition decision. Five are computed directly from CBA outputs; three (feasibility, equity, climate resilience) are expert-scored on a 0–1 scale. Economic efficiency receives the largest weight, but the combined non-economic criteria ensure that a scenario cannot rank highly on economics alone.

```{python}
#| label: mca-weights
weights = mca.get("weights", {})
```

| Criterion | Weight | Metric | Source |
|---|---|---|---|
| Economic Efficiency | `{python} f"{weights.get('economic_efficiency', 0.20)*100:.0f}"`% | NPV savings vs. BAU | CBA model output |
| Environmental Impact | `{python} f"{weights.get('environmental_impact', 0.15)*100:.0f}"`% | Cumulative CO₂ reduction | CBA model output |
| Energy Security | `{python} f"{weights.get('energy_security', 0.15)*100:.0f}"`% | Final RE share | CBA model output |
| Health Benefits | `{python} f"{weights.get('health_benefits', 0.10)*100:.0f}"`% | Health co-benefits ($M) | CBA model output |
| Fiscal Burden | `{python} f"{weights.get('fiscal_burden', 0.10)*100:.0f}"`% | Total CAPEX (lower = better) | CBA model output |
| Implementation Feasibility | `{python} f"{weights.get('implementation_feasibility', 0.10)*100:.0f}"`% | Expert assessment (0–1) | Expert scoring |
| Social Equity | `{python} f"{weights.get('social_equity', 0.10)*100:.0f}"`% | Expert assessment (0–1) | Expert scoring |
| Climate Resilience | `{python} f"{weights.get('climate_resilience', 0.10)*100:.0f}"`% | Expert assessment (0–1) | Expert scoring |

The weight sensitivity analysis below tests whether rankings hold under alternative weighting schemes.

## Results: Weighted Scores

Total weighted MCA scores (higher = better), with each criterion normalised 0–1 before applying weights:

```{python}
#| label: fig-mca-ranking
#| fig-cap: "MCA weighted scores by scenario. Higher is better. S6 (Maximum RE) ranks first under base weights."

mca_scenarios = mca.get("scenarios", {})
ranking = mca.get("ranking", [])

if mca_scenarios:
    # Build score data
    scenario_scores = {}
    for sid, sdata in mca_scenarios.items():
        if isinstance(sdata, dict):
            total = sdata.get("total_weighted_score", sdata.get("total_score", sdata.get("weighted_total", 0)))
            scenario_scores[sid] = total
    
    if scenario_scores:
        sorted_scenarios = sorted(scenario_scores.keys(), key=lambda s: scenario_scores[s], reverse=True)
        
        fig = go.Figure(go.Bar(
            x=[SCENARIO_SHORT.get(s, s) for s in sorted_scenarios],
            y=[scenario_scores[s] for s in sorted_scenarios],
            marker_color=[SCENARIO_COLORS.get(s, "#333") for s in sorted_scenarios],
            text=[f"{scenario_scores[s]:.2f}" for s in sorted_scenarios],
            textposition="outside",
        ))
        fig.update_layout(
            title="MCA Weighted Scores (Base Weights)",
            yaxis_title="Weighted Score",
            height=420,
            showlegend=False,
        )
        fig.show()
```

The MCA reinforces the CBA findings while adding nuance. High-RE scenarios (S6, S3, S5) cluster at the top: they combine fuel savings with deep emissions reductions, energy independence, and health co-benefits. Fossil-retaining pathways (LNG, cable) score well on economic efficiency but are penalised on environment, security, and resilience.

The heatmap disaggregates scores by criterion (darker green = better):

```{python}
#| label: fig-mca-heatmap
#| fig-cap: "Normalised scores by criterion and scenario. Darker green indicates better performance."

if mca_scenarios:
    # Get criteria list from first scenario's criteria dict
    first_s = next(iter(mca_scenarios.values()), {})
    criteria_dict = first_s.get("criteria", {})
    criteria = list(criteria_dict.keys()) if criteria_dict else list(weights.keys())
    
    if criteria:
        z_data = []
        y_labels = []
        for sid in SCENARIO_IDS:
            if sid in mca_scenarios and sid != "bau":
                sdata = mca_scenarios[sid]
                crit_data = sdata.get("criteria", sdata)
                row = []
                for c in criteria:
                    if isinstance(crit_data.get(c), dict):
                        score = crit_data[c].get("normalised", crit_data[c].get("weighted_score", 0))
                    else:
                        score = crit_data.get(c, 0)
                    row.append(score if isinstance(score, (int, float)) else 0)
                z_data.append(row)
                y_labels.append(SCENARIO_SHORT.get(sid, sid))
        
        if z_data:
            fig = go.Figure(data=go.Heatmap(
                z=z_data,
                x=[criteria_dict[c].get("label", c.replace("_", " ").title()) if isinstance(criteria_dict.get(c), dict) else c.replace("_", " ").title() for c in criteria],
                y=y_labels,
                colorscale="Greens",
                text=[[f"{v:.2f}" for v in row] for row in z_data],
                texttemplate="%{text}",
                showscale=True,
                colorbar_title="Score",
            ))
            fig.update_layout(
                title="MCA Score Heatmap (normalised, 0–1)",
                height=350,
                xaxis_tickangle=-35,
            )
            fig.show()
```

Renewable-intensive pathways score well on environmental impact, energy security, and health but may lag on fiscal burden and feasibility. The India cable (S2) pairs high economic efficiency with weaker security and resilience — single-point-of-failure risk and geopolitical exposure. LNG (S7) scores well on economics and feasibility but lower on environment. S4 (Islanded Green) ranks well on feasibility and equity but lower on environmental impact because Malé retains more diesel without near-shore or floating solar.

## Weight Sensitivity: Does the Ranking Hold?

Different stakeholders assign different weights. The test below runs five alternative profiles (environment-first, fiscal-first, social-equity, balanced, etc.):

```{python}
#| label: fig-weight-sensitivity
#| fig-cap: "MCA rankings under five different weight profiles. A stable ranking across profiles indicates robustness."

weight_sens = mca.get("weight_sensitivity", {})
if weight_sens:
    profiles = list(weight_sens.keys())
    
    fig = go.Figure()
    for sid in ALT_SCENARIOS:
        ranks = []
        for profile in profiles:
            profile_data = weight_sens[profile]
            if isinstance(profile_data, dict):
                profile_ranking = profile_data.get("ranking", [])
                if isinstance(profile_ranking, list):
                    # ranking is list of dicts with 'scenario' and 'rank' keys
                    rank = len(ALT_SCENARIOS)
                    for entry in profile_ranking:
                        if isinstance(entry, dict) and entry.get("scenario") == sid:
                            rank = entry.get("rank", rank)
                            break
                        elif entry == sid:  # fallback: flat list
                            rank = profile_ranking.index(sid) + 1
                            break
                else:
                    rank = len(ALT_SCENARIOS)
            else:
                rank = len(ALT_SCENARIOS)
            ranks.append(rank)
        
        fig.add_trace(go.Scatter(
            x=[p.replace("_", " ").title() for p in profiles],
            y=ranks,
            mode="lines+markers",
            name=SCENARIO_SHORT[sid],
            line=dict(color=SCENARIO_COLORS[sid], width=2),
            marker=dict(size=8),
        ))
    
    fig.update_layout(
        title="Scenario Rankings Under Different Weight Profiles",
        yaxis_title="Rank (1 = best)",
        yaxis=dict(autorange="reversed", dtick=1),
        height=450,
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
    )
    fig.show()
else:
    print("Weight sensitivity data not available.")
```

::: {.callout-tip}
Top-performing scenarios hold their positions across all five weight profiles. The ranking is not sensitive to how criteria are weighted, which means the conclusions rest on performance, not on the weighting scheme.
:::

This stability across weight profiles indicates that the top scenarios genuinely dominate on multiple fronts rather than benefiting from a single favourable assumption.

**Limitations:** Three expert-scored criteria involve judgement, normalisation can compress meaningful differences, and the linear additive model assumes full compensability between criteria.
